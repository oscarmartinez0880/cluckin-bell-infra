name: Infra Terraform (manual)

on:
  workflow_dispatch:
    inputs:
      env:
        description: Environment (nonprod|prod)
        required: true
        default: nonprod
      action:
        description: Action (plan|apply|destroy)
        required: true
        default: plan
      region:
        description: AWS region
        required: true
        default: us-east-1

jobs:
  terraform:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4

      - name: Select TF dir and profile
        id: sel
        run: |
          ENV="${{ github.event.inputs.env }}"
          REGION="${{ github.event.inputs.region }}"
          if [ "$ENV" = "nonprod" ]; then TF_DIR="envs/nonprod"; PROFILE="cluckin-bell-qa";
          elif [ "$ENV" = "prod" ]; then TF_DIR="envs/prod"; PROFILE="cluckin-bell-prod";
          else echo "Invalid env"; exit 1; fi
          echo "TF_DIR=$TF_DIR" >> $GITHUB_OUTPUT
          echo "PROFILE=$PROFILE" >> $GITHUB_OUTPUT
          echo "REGION=$REGION" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ steps.sel.outputs.REGION }}
          audience: sts.amazonaws.com
          role-to-assume: ${{ steps.sel.outputs.PROFILE == 'cluckin-bell-qa' && secrets.AWS_TERRAFORM_ROLE_ARN_QA || secrets.AWS_TERRAFORM_ROLE_ARN_PROD }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.1

      - name: Terraform Init
        working-directory: ${{ steps.sel.outputs.TF_DIR }}
        run: terraform init -upgrade

      - name: Terraform ${{ github.event.inputs.action }}
        working-directory: ${{ steps.sel.outputs.TF_DIR }}
        env:
          AWS_REGION: ${{ steps.sel.outputs.REGION }}
        run: |
          case "${{ github.event.inputs.action }}" in
            plan) terraform validate && terraform fmt -recursive && terraform plan -var="aws_region=$AWS_REGION" ;;
            apply) terraform apply -auto-approve -var="aws_region=$AWS_REGION" ;;
            destroy) terraform destroy -auto-approve -var="aws_region=$AWS_REGION" ;;
            *) echo "invalid action"; exit 1 ;;
          esac
