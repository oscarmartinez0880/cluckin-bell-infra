# ECR Workflow Testing Guide

This guide explains how to run and monitor ECR workflow dispatch tests for the Cluckin' Bell infrastructure.

## Overview

The ECR workflow tests validate that container images can be built, tagged, and pushed to the correct Amazon ECR repositories across all environments (dev, qa, prod) for both applications (cluckin-bell-app, wingman-api).

## Test Components

### 1. GitHub Workflow: `.github/workflows/test-ecr-workflow.yml`

A comprehensive workflow_dispatch workflow that:
- Tests ECR authentication using GitHub OIDC
- Validates ECR repository access
- Simulates container image building
- Tests image pushing to ECR (when not in dry-run mode)
- Generates detailed test reports

### 2. Test Runner Script: `scripts/run-ecr-tests.sh`

A helper script that:
- Triggers workflow tests with various configurations
- Monitors workflow execution
- Downloads test results and logs
- Generates comprehensive reports

## Environment Configuration

| Environment | AWS Account | ECR Base URL | Applications |
|-------------|-------------|--------------|--------------|
| dev | 264765154707 (cluckin-bell-qa) | 264765154707.dkr.ecr.us-east-1.amazonaws.com | cluckin-bell-app, wingman-api |
| qa | 264765154707 (cluckin-bell-qa) | 264765154707.dkr.ecr.us-east-1.amazonaws.com | cluckin-bell-app, wingman-api |
| prod | 346746763840 (cluckin-bell-prod) | 346746763840.dkr.ecr.us-east-1.amazonaws.com | cluckin-bell-app, wingman-api |

## Expected Image Tags

- **dev**: `dev` tag
- **qa**: `qa` tag  
- **prod**: `prod` and `latest` tags

## Usage Instructions

### Prerequisites

1. **GitHub CLI**: Install from [cli.github.com](https://cli.github.com/)
2. **jq**: JSON processor for parsing API responses
3. **Authenticated GitHub CLI**: Run `gh auth login`

### Quick Start

```bash
# 1. Run dry-run tests for all environments and applications
./scripts/run-ecr-tests.sh run-tests

# 2. Check the status
./scripts/run-ecr-tests.sh check-status

# 3. Download and view results
./scripts/run-ecr-tests.sh download-logs
```

### Detailed Testing Scenarios

#### 1. Dry Run Tests (Safe - No ECR Operations)

```bash
# Test all environments and applications (dry run)
./scripts/run-ecr-tests.sh run-tests --environment all --application all --dry-run true

# Test specific environment
./scripts/run-ecr-tests.sh run-tests --environment dev --application all --dry-run true
```

#### 2. Live Tests (Performs Actual ECR Operations)

```bash
# Test dev environment with actual ECR operations
./scripts/run-ecr-tests.sh run-tests --environment dev --application all --dry-run false --wait

# Test specific application in qa
./scripts/run-ecr-tests.sh run-tests --environment qa --application cluckin-bell-app --dry-run false --wait

# Test production (use with caution)
./scripts/run-ecr-tests.sh run-tests --environment prod --application all --dry-run false --wait
```

#### 3. Complete Test Suite

```bash
# Run comprehensive tests across all environments
./scripts/run-ecr-tests.sh run-tests --environment all --application all --dry-run false --wait
```

### Manual Workflow Execution

You can also trigger tests directly via GitHub CLI:

```bash
# Dry run test
gh workflow run test-ecr-workflow.yml \
  --repo oscarmartinez0880/cluckin-bell-infra \
  --field environment=dev \
  --field application=all \
  --field dry_run=true

# Live test
gh workflow run test-ecr-workflow.yml \
  --repo oscarmartinez0880/cluckin-bell-infra \
  --field environment=dev \
  --field application=all \
  --field dry_run=false
```

### Monitoring and Results

#### Check Workflow Status

```bash
# View recent workflow runs
./scripts/run-ecr-tests.sh check-status

# View specific run details
gh run view <RUN_ID> --repo oscarmartinez0880/cluckin-bell-infra
```

#### Download Test Results

```bash
# Download latest results
./scripts/run-ecr-tests.sh download-logs

# Download specific run
./scripts/run-ecr-tests.sh download-logs --run-id 1234567890

# Generate comprehensive report
./scripts/run-ecr-tests.sh generate-report
```

## Test Reports

The workflow generates several types of reports:

### Individual Test Reports
- **Format**: Markdown files per application/environment combination
- **Content**: Detailed test results, image URIs, next steps
- **Location**: Workflow artifacts

### Summary Report
- **Format**: Single markdown file
- **Content**: Overview of all tests in the run
- **Location**: Workflow artifacts

### Comprehensive Report
- **Format**: Consolidated markdown file
- **Content**: Combined results from multiple test runs
- **Generated by**: `generate-report` command

## Expected Test Results

### Successful Dry Run Test
```
âœ… Environment Setup - Configuration validated
ðŸ”¸ ECR Authentication - Skipped (dry run)
ðŸ”¸ ECR Repository Access - Skipped (dry run)  
âœ… Image Build - Test image built locally
ðŸ”¸ ECR Push - Skipped (dry run)
```

### Successful Live Test
```
âœ… Environment Setup - Configuration validated
âœ… ECR Authentication - OIDC authentication to AWS
âœ… ECR Repository Access - Repository exists and accessible
âœ… Image Build - Test image built locally
âœ… ECR Push - Image pushed to ECR
```

## Troubleshooting

### Common Issues

#### 1. ECR Authentication Failed
**Symptoms**: AWS OIDC authentication errors
**Solutions**:
- Verify GitHub OIDC provider is configured in AWS
- Check IAM role trust policies
- Ensure repository has correct environment secrets

#### 2. ECR Repository Not Found
**Symptoms**: Repository does not exist errors
**Solutions**:
- Run Terraform to create ECR repositories
- Verify account IDs match configuration
- Check region settings (should be us-east-1)

#### 3. Permission Denied on ECR Push
**Symptoms**: Access denied when pushing images
**Solutions**:
- Verify IAM role has ECR push permissions
- Check ECR repository policies
- Ensure role is assumed correctly

#### 4. Workflow Fails to Trigger
**Symptoms**: No workflow run created
**Solutions**:
- Check GitHub CLI authentication
- Verify repository access permissions
- Ensure workflow file syntax is correct

### Debug Commands

```bash
# Check AWS CLI configuration (if available)
aws sts get-caller-identity

# Test ECR login manually
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 264765154707.dkr.ecr.us-east-1.amazonaws.com

# List ECR repositories
aws ecr describe-repositories --region us-east-1

# View workflow logs
gh run view <RUN_ID> --log --repo oscarmartinez0880/cluckin-bell-infra
```

## Integration with CI/CD

These tests can be integrated into your CI/CD pipeline:

1. **Pre-deployment validation**: Run tests before deploying applications
2. **Infrastructure verification**: Validate ECR setup after Terraform changes
3. **Scheduled testing**: Run periodic tests to ensure ECR health

### Example Pipeline Integration

```yaml
# In your application repository workflow
- name: Validate ECR Infrastructure
  uses: ./.github/workflows/test-ecr-workflow.yml
  with:
    environment: ${{ github.event.deployment.environment }}
    application: cluckin-bell-app
    dry_run: false
```

## Security Considerations

1. **Dry Run First**: Always test with dry_run=true before live tests
2. **Environment Isolation**: Prod tests should only run after dev/qa validation
3. **Credential Security**: Uses GitHub OIDC, no long-lived AWS credentials
4. **Minimal Permissions**: IAM roles have minimal required permissions

## Next Steps

After successful ECR tests:

1. **Deploy Applications**: Use the validated ECR images for deployment
2. **Monitor Usage**: Set up CloudWatch monitoring for ECR repositories
3. **Automate Cleanup**: Implement lifecycle policies for old images
4. **Scale Testing**: Extend tests to include image vulnerability scanning

## Support

For issues or questions:

1. Check the [troubleshooting section](#troubleshooting)
2. Review workflow logs in GitHub Actions
3. Examine Terraform ECR configuration
4. Create an issue in the repository